<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
</head>

<body>
    <div class="container">
        <h2 class="mt-5 text-center">Profile Page</h2>

        <h3 class=" mt-5">Welcome User : <span class="text-success">{{ email }}</span> </h3>
        <form method="POST" action="{% url 'logout' %}" class="text-right">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>

        <div class="mt-4">
            <h3>Search Users by Email</h3>
            <input type="text" class="form-control" id="searchInput" placeholder="Search for users by email...">
            <div class="mt-3">
                <div>
                    <div id="recordCount"></div>
                    <nav aria-label="Page navigation" id="paginationControls" class="mt-3">
                        <ul class="pagination">
                        </ul>
                    </nav>
                </div>
                <table class="table table-striped" id="searchResults">
                    <thead>
                        <tr>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>


            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            let currentPage = 1;
            const loggedInEmail = "{{ email }}";

            function fetchUsers(query, page = 1) {
                $.ajax({
                    url: "{% url 'user_search' %}",
                    type: 'GET',
                    data: {
                        'query': query,
                        'page': page
                    },
                    success: function (data) {
                        $('#searchResults tbody').html('');
                        $('#recordCount').text(`Showing ${data.results.length} of ${data.count} records`);
                        const sentRequestEmails = new Set();
                        data.friendRequests.forEach(request => {
                            if (request.from_user === loggedInEmail) {
                                sentRequestEmails.add(request.to_user);
                            }
                        });
                        if (data.results.length > 0) {
                            $.each(data.results, function (index, user) {
                                if (user.email !== loggedInEmail) {
                                    const buttonText = sentRequestEmails.has(user.email) ? "Friend request sent" : "Send Request";
                                    const buttonDisabled = sentRequestEmails.has(user.email) ? "disabled" : "";
                                    const buttonClass = sentRequestEmails.has(user.email) ? "btn-secondary" : "btn-primary";

                                    $('#searchResults tbody').append(`
                                        <tr>
                                            <td>
                                                ${user.email}
                                                <button class="btn ${buttonClass} float-right requestSent" data-email="${user.email}" ${buttonDisabled}>
                                                    <span class="requested">${buttonText}</span>
                                                </button>
                                            </td>
                                        </tr>
                                    `);
                                }
                            });
                            $('#paginationControls ul').html('');
                            if (data.previous) {
                                $('#paginationControls ul').append(`
                                    <li class="page-item">
                                        <button class="btn btn-success  mr-5" href="#" id="prevButton">Previous</button>
                                    </li>
                                `);
                            }
                            if (data.next) {
                                $('#paginationControls ul').append(`
                                    <li class="page-item">
                                        <button class="btn btn-success" href="#" id="nextButton">Next</button>
                                    </li>
                                `);
                            }
                        } else {
                            $('#searchResults tbody').html('<tr><td>No users found.</td></tr>');
                        }
                    }
                });
            }

            $('#searchInput').on('input', function () {
                let query = $(this).val();
                currentPage = 1;
                if (query.length > 0) {
                    fetchUsers(query, currentPage);
                } else {
                    $('#searchResults tbody').html('');
                    $('#recordCount').text('');
                    $('#paginationControls ul').html('');
                }
            });
            $(document).on('click', '#nextButton', function (e) {
                e.preventDefault();
                currentPage++;
                let query = $('#searchInput').val();
                fetchUsers(query, currentPage);
            });
            $(document).on('click', '#prevButton', function (e) {
                e.preventDefault();
                currentPage--;
                let query = $('#searchInput').val();
                fetchUsers(query, currentPage);
            });
            $(document).on('click', '.requestSent', function (e) {
                e.preventDefault();
                var clickedUserEmail = $(this).data('email');
                var button = $(this);
                $.ajax({
                    type: "POST",
                    url: "/send_friend_request/",
                    data: {
                        'from_email': loggedInEmail,
                        'to_email': clickedUserEmail,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        button.html('<span class="requested">Friend request sent</span>').removeClass('btn-primary').addClass('btn-secondary').prop('disabled', true);
                    },
                    error: function (error) {
                        if (error.status === 400) {
                            alert(error.responseJSON.error);
                        } else {
                            console.error("Error sending friend request:", error);
                        }
                    }
                });
            });

        });
    </script>
</body>

</html>